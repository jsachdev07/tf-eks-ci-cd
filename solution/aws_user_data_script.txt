#!/bin/bash
# ===========================
# EC2 User Data Script
# Installs Jenkins, Maven, Docker, Terraform, kubectl, and AWS CLI
# ===========================

# Update system packages
apt-get update -y
apt-get upgrade -y

# Install basic dependencies
apt-get install -y wget curl git unzip fontconfig openjdk-17-jre

# ===========================
# Install Jenkins
# ===========================
wget -O /usr/share/keyrings/jenkins-keyring.asc https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key

echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/" \
  | tee /etc/apt/sources.list.d/jenkins.list > /dev/null

apt-get update -y
apt-get install -y jenkins

systemctl enable jenkins
systemctl start jenkins

# ===========================
# Install Apache Maven 3.9.9
# ===========================
cd /tmp
wget https://archive.apache.org/dist/maven/maven-3/3.9.9/binaries/apache-maven-3.9.9-bin.tar.gz
mkdir -p /opt/maven
tar -xvzf apache-maven-3.9.9-bin.tar.gz -C /opt/maven/ --strip-components=1
ln -s /opt/maven/bin/mvn /usr/bin/mvn
mvn --version

# ===========================
# Install Docker
# ===========================
apt-get install -y docker.io
systemctl enable docker
systemctl start docker
chown root:jenkins /var/run/docker.sock

# ===========================
# Install Terraform 1.13.5
# ===========================
cd /tmp
wget https://releases.hashicorp.com/terraform/1.13.5/terraform_1.13.5_linux_amd64.zip
unzip terraform_1.13.5_linux_amd64.zip
mv terraform /usr/local/bin/
terraform -version

# ===========================
# Install kubectl 1.33.0
# ===========================
cd /tmp
curl -LO "https://dl.k8s.io/release/v1.33.0/bin/linux/amd64/kubectl"
chmod +x kubectl
mv kubectl /usr/local/bin/
kubectl version --client

# ===========================
# Install AWS CLI v2
# ===========================
cd /tmp
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install
aws --version

# ===========================
# Final status
# ===========================
echo "===================================================="
echo "Installation completed successfully!"
echo "Jenkins is running on port 8080."
echo "===================================================="
